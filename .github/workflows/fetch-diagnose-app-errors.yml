name: Fetch and Diagnose App Errors

on:
  workflow_dispatch:
    inputs:
      time_range:
        description: 'Time range for logs (in minutes, e.g., 60 for last hour)'
        required: false
        default: '60'
      app_name:
        description: 'Azure Web App name'
        required: false
        default: 'mosaic-saas'

env:
  AZURE_WEBAPP_NAME: mosaic-saas
  AZURE_RESOURCE_GROUP: mosaic-rg

jobs:
  fetch-and-diagnose:
    name: Fetch Azure Logs and Diagnose Errors
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Get Azure Web App Details
      id: app-details
      run: |
        echo "Fetching Azure Web App details..."
        APP_NAME="${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
        
        # Get app URL
        APP_URL=$(az webapp show --name "$APP_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query "defaultHostName" -o tsv 2>/dev/null || echo "")
        if [ -n "$APP_URL" ]; then
          echo "app_url=https://$APP_URL" >> $GITHUB_OUTPUT
          echo "âœ“ App URL: https://$APP_URL"
        else
          echo "âš ï¸ Could not retrieve app URL"
          echo "app_url=N/A" >> $GITHUB_OUTPUT
        fi
        
        # Get app state
        APP_STATE=$(az webapp show --name "$APP_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --query "state" -o tsv 2>/dev/null || echo "Unknown")
        echo "app_state=$APP_STATE" >> $GITHUB_OUTPUT
        echo "âœ“ App State: $APP_STATE"
    
    - name: Check App Health
      id: health-check
      continue-on-error: true
      run: |
        APP_URL="${{ steps.app-details.outputs.app_url }}"
        if [ "$APP_URL" = "N/A" ]; then
          echo "âŒ Cannot check health - app URL not available"
          echo "health_status=error" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Checking health endpoint: $APP_URL/api/health"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/health" || echo "000")
        echo "HTTP Status Code: $HTTP_CODE"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ“ Health check passed"
          echo "health_status=healthy" >> $GITHUB_OUTPUT
        else
          echo "âŒ Health check failed with status: $HTTP_CODE"
          echo "health_status=unhealthy" >> $GITHUB_OUTPUT
        fi
    
    - name: Fetch Application Logs
      id: fetch-logs
      run: |
        echo "Fetching application logs..."
        APP_NAME="${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
        TIME_RANGE="${{ github.event.inputs.time_range || '60' }}"
        
        # Create logs directory
        mkdir -p logs
        
        # Fetch application logs
        echo "Fetching logs from the last $TIME_RANGE minutes..."
        az webapp log download \
          --name "$APP_NAME" \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --log-file logs/app-logs.zip 2>&1 || echo "âš ï¸ Could not download full log archive"
        
        # Extract logs if downloaded
        if [ -f logs/app-logs.zip ]; then
          echo "âœ“ Logs downloaded successfully"
          cd logs
          unzip -q app-logs.zip 2>/dev/null || echo "âš ï¸ Could not extract logs"
          cd ..
        fi
        
        # Fetch recent log stream (last 100 lines)
        echo "Fetching recent log stream..."
        az webapp log tail \
          --name "$APP_NAME" \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --only-show-errors 2>/dev/null | head -100 > logs/recent-log-stream.txt || echo "âš ï¸ Could not fetch log stream"
        
        echo "log_collection_complete=true" >> $GITHUB_OUTPUT
    
    - name: Fetch Docker/Container Logs
      continue-on-error: true
      run: |
        echo "Fetching container logs..."
        APP_NAME="${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
        
        # Get container logs (if app runs in container)
        # Note: --only-show-errors suppresses Azure CLI warnings, not application log content
        az webapp log show \
          --name "$APP_NAME" \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --only-show-errors 2>/dev/null > logs/container-logs.txt || echo "âš ï¸ Container logs not available"
    
    - name: Fetch Event Logs
      continue-on-error: true
      run: |
        echo "Fetching Azure activity logs..."
        APP_NAME="${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
        TIME_RANGE="${{ github.event.inputs.time_range || '60' }}"
        
        # Calculate start time
        START_TIME=$(date -u -d "$TIME_RANGE minutes ago" +"%Y-%m-%dT%H:%M:%SZ")
        
        # Fetch activity logs
        az monitor activity-log list \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --start-time "$START_TIME" \
          --query "[?contains(resourceId, '$APP_NAME')]" \
          --output json > logs/activity-logs.json 2>/dev/null || echo "âš ï¸ Activity logs not available"
    
    - name: Get App Service Configuration
      continue-on-error: true
      run: |
        echo "Fetching app configuration..."
        APP_NAME="${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
        
        # Get app settings (secrets will be masked)
        az webapp config appsettings list \
          --name "$APP_NAME" \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --output json > logs/app-settings.json 2>/dev/null || echo "âš ï¸ App settings not available"
        
        # Get connection strings (values will be masked for security)
        az webapp config connection-string list \
          --name "$APP_NAME" \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --output json > logs/connection-strings.json 2>/dev/null || echo "âš ï¸ Connection strings not available"
    
    - name: Analyze Logs for Common Errors
      id: analyze-errors
      run: |
        echo "Analyzing logs for common errors..."
        
        # Create analysis report header
        {
          echo "========================================"
          echo "MOSAIC Azure App Error Analysis Report"
          echo "========================================"
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "App Details:"
          echo "- Name: ${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
          echo "- URL: ${{ steps.app-details.outputs.app_url }}"
          echo "- State: ${{ steps.app-details.outputs.app_state }}"
          echo "- Health Status: ${{ steps.health-check.outputs.health_status }}"
          echo ""
          echo "========================================"
          echo "Common Error Patterns Detected"
          echo "========================================"
          echo ""
        } > logs/error-analysis.txt
        
        # Search for common error patterns in all log files
        ERROR_FOUND=false
        
        # Check for HTTP 500.30 errors
        if grep -r "500.30" logs/ 2>/dev/null > /tmp/error_check.txt; then
          echo "" >> logs/error-analysis.txt
          echo "âŒ HTTP 500.30 ERROR DETECTED" >> logs/error-analysis.txt
          echo "   - ASP.NET Core app failed to start" >> logs/error-analysis.txt
          echo "   - See TROUBLESHOOTING_HTTP_500_30.md for detailed guidance" >> logs/error-analysis.txt
          echo "   - Common causes: missing connection string, database issues, config errors" >> logs/error-analysis.txt
          head -5 /tmp/error_check.txt >> logs/error-analysis.txt
          ERROR_FOUND=true
        fi
        
        # Check for database connection errors
        if grep -ri "connection.*fail\|cannot connect\|timeout.*database\|SqlException" logs/ 2>/dev/null > /tmp/error_check.txt; then
          echo "" >> logs/error-analysis.txt
          echo "âŒ DATABASE CONNECTION ERROR DETECTED" >> logs/error-analysis.txt
          echo "   - Check connection string in Azure Portal â†’ Configuration" >> logs/error-analysis.txt
          echo "   - Verify database server is accessible" >> logs/error-analysis.txt
          echo "   - Ensure firewall rules allow Azure services" >> logs/error-analysis.txt
          head -5 /tmp/error_check.txt >> logs/error-analysis.txt
          ERROR_FOUND=true
        fi
        
        # Check for authentication errors
        if grep -ri "authentication.*fail\|unauthorized\|401\|403" logs/ 2>/dev/null > /tmp/error_check.txt; then
          echo "" >> logs/error-analysis.txt
          echo "âŒ AUTHENTICATION ERROR DETECTED" >> logs/error-analysis.txt
          echo "   - Check JWT configuration" >> logs/error-analysis.txt
          echo "   - Verify Identity configuration" >> logs/error-analysis.txt
          echo "   - Review AUTHENTICATION_README.md" >> logs/error-analysis.txt
          head -5 /tmp/error_check.txt >> logs/error-analysis.txt
          ERROR_FOUND=true
        fi
        
        # Check for missing dependencies/files
        if grep -ri "FileNotFoundException\|could not find file\|missing.*dll" logs/ 2>/dev/null > /tmp/error_check.txt; then
          echo "" >> logs/error-analysis.txt
          echo "âŒ MISSING FILES/DEPENDENCIES DETECTED" >> logs/error-analysis.txt
          echo "   - Verify deployment package is complete" >> logs/error-analysis.txt
          echo "   - Check web.config exists in deployment" >> logs/error-analysis.txt
          echo "   - Ensure all NuGet packages are included" >> logs/error-analysis.txt
          head -5 /tmp/error_check.txt >> logs/error-analysis.txt
          ERROR_FOUND=true
        fi
        
        # Check for memory/resource issues
        if grep -ri "OutOfMemoryException\|memory.*limit\|quota.*exceed" logs/ 2>/dev/null > /tmp/error_check.txt; then
          echo "" >> logs/error-analysis.txt
          echo "âŒ MEMORY/RESOURCE ERROR DETECTED" >> logs/error-analysis.txt
          echo "   - Consider scaling up App Service plan" >> logs/error-analysis.txt
          echo "   - Review memory usage patterns" >> logs/error-analysis.txt
          echo "   - Check for memory leaks" >> logs/error-analysis.txt
          head -5 /tmp/error_check.txt >> logs/error-analysis.txt
          ERROR_FOUND=true
        fi
        
        # Check for configuration errors
        if grep -ri "configuration.*error\|InvalidOperationException.*config\|missing.*setting" logs/ 2>/dev/null > /tmp/error_check.txt; then
          echo "" >> logs/error-analysis.txt
          echo "âŒ CONFIGURATION ERROR DETECTED" >> logs/error-analysis.txt
          echo "   - Verify all required app settings in Azure Portal" >> logs/error-analysis.txt
          echo "   - Check .env.example for required variables" >> logs/error-analysis.txt
          echo "   - Review DEPLOYMENT_NOTES.md" >> logs/error-analysis.txt
          head -5 /tmp/error_check.txt >> logs/error-analysis.txt
          ERROR_FOUND=true
        fi
        
        if [ "$ERROR_FOUND" = "false" ]; then
          echo "" >> logs/error-analysis.txt
          echo "âœ“ No common error patterns detected in logs" >> logs/error-analysis.txt
          echo "  Review the full logs for detailed information" >> logs/error-analysis.txt
        fi
        
        echo "" >> logs/error-analysis.txt
        echo "========================================" >> logs/error-analysis.txt
        echo "Next Steps" >> logs/error-analysis.txt
        echo "========================================" >> logs/error-analysis.txt
        echo "1. Download the workflow artifacts (logs)" >> logs/error-analysis.txt
        echo "2. Review error-analysis.txt for detected issues" >> logs/error-analysis.txt
        echo "3. Check recent-log-stream.txt for recent errors" >> logs/error-analysis.txt
        echo "4. Consult relevant troubleshooting docs in repository" >> logs/error-analysis.txt
        echo "5. If needed, enable more detailed logging in Azure Portal" >> logs/error-analysis.txt
        echo "" >> logs/error-analysis.txt
        echo "Relevant Documentation:" >> logs/error-analysis.txt
        echo "- TROUBLESHOOTING_HTTP_500_30.md" >> logs/error-analysis.txt
        echo "- DEPLOYMENT_NOTES.md" >> logs/error-analysis.txt
        echo "- AUTHENTICATION_README.md" >> logs/error-analysis.txt
        echo "- ERROR_LOGGING_TROUBLESHOOTING.md" >> logs/error-analysis.txt
        
        # Display the analysis
        cat logs/error-analysis.txt
        
        # Set output for summary
        if [ "$ERROR_FOUND" = "true" ]; then
          echo "errors_detected=true" >> $GITHUB_OUTPUT
        else
          echo "errors_detected=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Diagnostic Summary
      run: |
        {
          echo "# Azure App Diagnostic Summary"
          echo ""
          echo "## Workflow Information"
          echo "- **Run ID**: ${{ github.run_id }}"
          echo "- **Run URL**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- **Triggered By**: ${{ github.actor }}"
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "## Application Information"
          echo "- **App Name**: ${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}"
          echo "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo "- **App URL**: ${{ steps.app-details.outputs.app_url }}"
          echo "- **App State**: ${{ steps.app-details.outputs.app_state }}"
          echo "- **Health Status**: ${{ steps.health-check.outputs.health_status }}"
          echo ""
          echo "## Log Collection Summary"
          echo "- **Time Range**: Last ${{ github.event.inputs.time_range || '60' }} minutes"
          echo "- **Logs Collected**: ${{ steps.fetch-logs.outputs.log_collection_complete }}"
          echo "- **Errors Detected**: ${{ steps.analyze-errors.outputs.errors_detected }}"
          echo ""
          echo "## Files in This Artifact"
          echo "1. **error-analysis.txt** - Automated error pattern analysis"
          echo "2. **recent-log-stream.txt** - Recent application logs (last 100 lines)"
          echo "3. **DIAGNOSTIC_SUMMARY.md** - This file"
          echo "4. **app-logs.zip** - Full log archive (if available)"
          echo "5. **container-logs.txt** - Container/Docker logs (if available)"
          echo "6. **activity-logs.json** - Azure activity logs (if available)"
          echo "7. **app-settings.json** - Application settings (secrets masked)"
          echo "8. **connection-strings.json** - Connection string names (values masked)"
          echo ""
          echo "## Quick Actions"
          echo ""
          echo "### If Health Check Failed"
          echo "1. Check **error-analysis.txt** for detected issues"
          echo "2. Review **recent-log-stream.txt** for error details"
          echo "3. Verify database connection in Azure Portal"
          echo "4. Check all environment variables are set correctly"
          echo ""
          echo "### If No Errors Detected"
          echo "1. Review logs manually for warnings or performance issues"
          echo "2. Check application metrics in Azure Portal"
          echo "3. Consider enabling more verbose logging"
          echo ""
          echo "## Recommended Next Steps"
          echo "1. Review the error analysis report"
          echo "2. Consult relevant troubleshooting documentation:"
          echo "   - \`TROUBLESHOOTING_HTTP_500_30.md\`"
          echo "   - \`DEPLOYMENT_NOTES.md\`"
          echo "   - \`ERROR_LOGGING_TROUBLESHOOTING.md\`"
          echo "3. Apply fixes based on identified issues"
          echo "4. Re-run this workflow after fixes to verify resolution"
          echo ""
          echo "## Additional Resources"
          echo "- [Azure Portal - App Service Logs](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring_Logs/LogsBlade)"
          echo "- [Kudu Console](https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net)"
          echo "- [Azure Monitor](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/AzureMonitoringBrowseBlade)"
          echo ""
          echo "---"
          echo "*This diagnostic report was automatically generated by GitHub Actions*"
        } > logs/DIAGNOSTIC_SUMMARY.md
        
        # Display summary
        cat logs/DIAGNOSTIC_SUMMARY.md
    
    - name: Upload Logs as Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: azure-app-logs-${{ github.run_number }}
        path: logs/
        retention-days: 30
    
    - name: Create Workflow Summary
      if: always()
      run: |
        echo "## ðŸ” Azure App Diagnostics Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application Status" >> $GITHUB_STEP_SUMMARY
        echo "- **App**: ${{ github.event.inputs.app_name || env.AZURE_WEBAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ steps.app-details.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **State**: ${{ steps.app-details.outputs.app_state }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Health**: ${{ steps.health-check.outputs.health_status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.analyze-errors.outputs.errors_detected }}" = "true" ]; then
          echo "### âš ï¸ Errors Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common error patterns were found in the logs. Please review the artifact for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… No Common Errors Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No common error patterns found. Review logs manually for detailed analysis." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "All logs have been collected and uploaded as workflow artifacts." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Download artifacts**: [azure-app-logs-${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
        echo "- [Troubleshooting HTTP 500.30](./TROUBLESHOOTING_HTTP_500_30.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Deployment Notes](./DEPLOYMENT_NOTES.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Error Logging Guide](./ERROR_LOGGING_TROUBLESHOOTING.md)" >> $GITHUB_STEP_SUMMARY
    
    - name: Azure Logout
      if: always()
      run: |
        az logout
