<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <!-- 
    ASP.NET Core Module Configuration for IIS and Azure App Service
    
    This file is CRITICAL for Azure App Service deployments.
    Without it, the app will fail with HTTP Error 500.30.
    
    Troubleshooting Guide: https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/azure-apps/troubleshoot
  -->
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <!-- ASP.NET Core Module v2 (InProcess hosting model for best performance) -->
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      
      <aspNetCore processPath="dotnet"
                  arguments=".\OrkinosaiCMS.Web.dll"
                  stdoutLogEnabled="true"
                  stdoutLogFile=".\logs\stdout"
                  hostingModel="inprocess">
        <!-- 
          Environment Variables (override appsettings.json)
          Configure these in Azure Portal → Configuration → Application Settings instead for security
        -->
        <environmentVariables>
          <!-- Example: Uncomment to override environment -->
          <!-- <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" /> -->
        </environmentVariables>
      </aspNetCore>
      
      <!-- Security Headers -->
      <httpProtocol>
        <customHeaders>
          <remove name="X-Powered-By" />
        </customHeaders>
      </httpProtocol>
      
      <!-- Error Handling -->
      <httpErrors existingResponse="PassThrough" />
    </system.webServer>
  </location>
  
  <!-- 
    AZURE APP SERVICE NOTES:
    
    1. STDOUT LOGS:
       - Logs are written to D:\home\LogFiles\stdout on Azure App Service
       - Access via: Azure Portal → App Service → Advanced Tools (Kudu) → Debug Console
       - Or via FTP: /LogFiles/stdout/
       - These logs capture startup errors and unhandled exceptions
    
    2. ENABLE LOGGING IN AZURE:
       Azure Portal App Service App Service Logs:
       - Application Logging (Filesystem): On (Level: Verbose)
       - Web server logging: File System
       - This enables stdout capture
    
    3. COMMON STARTUP ERRORS CAPTURED:
       - Missing connection strings
       - Database migration failures
       - Configuration errors
       - Missing dependencies
       - Port binding issues
    
    4. VIEWING LOGS:
       - Real-time: Azure Portal Log Stream
       - Historical: Kudu LogFiles Application stdout
       - CLI: az webapp log tail
    
    5. TROUBLESHOOTING HTTP 500.30:
       a) Check stdout logs in D:\home\LogFiles\stdout
       b) Check Application logs in D:\home\LogFiles\Application
       c) Verify all environment variables are set in Configuration
       d) Ensure database connection string is correct
       e) Confirm .NET 10 runtime is installed (or self-contained deployment)
  -->
</configuration>
